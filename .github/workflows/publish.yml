name: publish-to-gar

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

env:
  # replace with your project id or set as repo variable ENV instead
  GCP_PROJECT: ${{ vars.GCP_PROJECT }}                # set in repo variables
  ARTIFACT_REGISTRY_LOCATION: ${{ vars.ARTIFACT_REGISTRY_LOCATION }} # e.g. us-central1
  ARTIFACT_REGISTRY_REPO: ${{ vars.ARTIFACT_REGISTRY_REPO }}         # your Python repo name

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Authenticate to GCP using Workload Identity Federation
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER_FULL }}
          service_account: ${{ vars.GCP_SA_EMAIL }}

      - name: Install gcloud SDK CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GCP_PROJECT }}
          export_default_credentials: true

      - name: Debug - show pyproject (helpful if builds fail)
        run: |
          echo "===== pyproject.toml (first 200 lines) ====="
          sed -n '1,200p' pyproject.toml || true

      - name: Install build tools (pip wheel build twine)
        run: |
          python -m pip install --upgrade pip
          python -m pip install build==1.1.0 twine==4.0.2

      - name: Build package (sdist + wheel)
        run: |
          python -m build --sdist --wheel

      - name: Configure Artifact Registry repo URL
        id: ar
        run: |
          # read variables from env
          REGION=${{ env.ARTIFACT_REGISTRY_LOCATION }}
          REPO=${{ env.ARTIFACT_REGISTRY_REPO }}
          PROJECT=${{ env.GCP_PROJECT }}

          # print-settings returns the repository URL for twine/pip
          REPO_URL=$(gcloud artifacts print-settings python \
            --project="$PROJECT" \
            --repository="$REPO" \
            --location="$REGION" \
            --format="value(repositoryUrl)")

          if [ -z "$REPO_URL" ]; then
            echo "ERROR: repo URL empty - check ARTIFACT_REGISTRY_REPO and ARTIFACT_REGISTRY_LOCATION"
            exit 1
          fi

          echo "repo_url=$REPO_URL" | tee $GITHUB_OUTPUT

      - name: Upload to Artifact Registry (via twine + short-lived token)
        run: |
          REPO_URL="${{ steps.ar.outputs.repo_url }}"
          echo "Using repository URL: $REPO_URL"

          # get an access token and use oauth2accesstoken as username for twine
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          if [ -z "$ACCESS_TOKEN" ]; then
            echo "ERROR: failed to get access token"
            exit 1
          fi

          # Twine needs repo URL and token
          python -m twine upload \
            --repository-url "${REPO_URL}" \
            -u oauth2accesstoken \
            -p "${ACCESS_TOKEN}" \
            dist/*

      # optional: run a quick install test from GAR (comment out if not needed)
      - name: Test install from Artifact Registry
        run: |
          REPO_URL="${{ steps.ar.outputs.repo_url }}"
          # Configure pip to use the GAR repo (this gives pip the correct package index)
          python -m pip install --index-url "${REPO_URL}" --extra-index-url https://pypi.org/simple your-package-name==${{ github.ref_name || '0.0.0' }} || true

